<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="zdZMpUR-FZn3NtutmKmKzmPnZIswFsPGKLACq5jj918" />
    <title>VisionTube - Nex-gen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* Basic Styling with CSS Variables for Accent Colors */
        :root {
            --accent-color-1: #a29bfe; /* Warna aksen 1 default */
            --accent-color-2: #7c5cff; /* Warna aksen 2 default */
            --accent-color-1-hover: #b1adff; /* Hover untuk aksen 1 */
            --accent-color-2-hover: #9174ff; /* Hover untuk aksen 2 */
            --accent-text-color: var(--accent-color-1); /* Warna teks aksen default */
            --accent-text-color-hover: var(--accent-color-1-hover);
            --button-bg-gradient: linear-gradient(to right, var(--accent-color-1), var(--accent-color-2));
            --button-bg-gradient-hover: linear-gradient(to right, var(--accent-color-1-hover), var(--accent-color-2-hover));
            --focus-ring-color: var(--accent-color-1);
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent-color-1), var(--accent-color-2)); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, var(--accent-color-1-hover), var(--accent-color-2-hover)); }
        body { font-family: 'Inter', sans-serif; background-color: #0f0f1a; color: #e0e0e0; }
        .glassmorphism { background: rgba(26, 26, 46, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(162, 155, 254, 0.2); border-radius: 1rem; }
        .gradient-text { background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }

        /* Grid & Navbar Scrollbar Hiding */
        #video-grid::-webkit-scrollbar,
        #search-results-grid::-webkit-scrollbar,
        #recently-viewed-grid::-webkit-scrollbar,
        #playlist-videos-grid::-webkit-scrollbar,
        #desktop-nav-container::-webkit-scrollbar,
        #desktop-sidebar-container::-webkit-scrollbar { display: none; }
        #video-grid, #search-results-grid, #recently-viewed-grid, #playlist-videos-grid, #desktop-nav-container, #desktop-sidebar-container { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mobile Sidebar */
        #mobile-sidebar { transition: transform 0.3s ease-in-out; }
        #mobile-sidebar.translate-x-full { transform: translateX(100%); }
        #mobile-sidebar.translate-x-0 { transform: translateX(0); }

        /* Loader */
        .loader { border: 4px solid #333; border-top: 4px solid var(--accent-color-1); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button:disabled .loader { width: 1.25rem; height: 1.25rem; border-width: 3px; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }

        /* YouTube Player */
        #youtube-player-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; background-color: #000; border-radius: 0.5rem; }
        #youtube-player-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* Video Card */
        .video-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 10px 20px rgba(124, 92, 255, 0.3); }
        .video-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }

        /* Video Description Link */
        #video-description a { color: var(--accent-text-color); text-decoration: underline; }
        #video-description a:hover { color: var(--accent-text-color-hover); }

        /* Fullscreen */
        .fullscreen { position: fixed !important; top: 0; left: 0; width: 100% !important; height: 100% !important; z-index: 10000; overflow: auto; background-color: #000; }
        #youtube-player-container.fullscreen { padding-bottom: 0; }
        @media screen and (orientation: landscape) { #youtube-player-container.fullscreen { width: 100vw; height: 100vh; } }

        /* Line Clamp */
        .line-clamp-1 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 1; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }

        /* Modal Styles */
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.hidden { opacity: 0; visibility: hidden; }
        .modal-content { transition: transform 0.3s ease; }
        .modal.hidden .modal-content { transform: scale(0.9); }

        /* Playlist Item Hover */
        .playlist-item:hover { background-color: rgba(162, 155, 254, 0.1); /* Consider using accent color alpha */ }

        /* Desktop Sidebar */
        #desktop-sidebar-container { position: fixed; top: 0; left: 0; height: 100%; width: 240px; background-color: #0f0f1a; border-right: 1px solid rgba(162, 155, 254, 0.2); box-shadow: 5px 0 10px rgba(0, 0, 0, 0.3); z-index: 60; padding-top: 70px; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        #desktop-sidebar-container.open { transform: translateX(0); }
        #desktop-sidebar-container nav { padding: 1rem; }
        #desktop-sidebar-container a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #e0e0e0; text-decoration: none; border-radius: 0.5rem; transition: background-color 0.2s ease, color 0.2s ease; }
        #desktop-sidebar-container a:hover { background-color: rgba(162, 155, 254, 0.1); color: var(--accent-text-color); }
        #desktop-sidebar-container a svg { width: 1.25rem; height: 1.25rem; fill: currentColor; transition: transform 0.2s ease-in-out; }
        #desktop-sidebar-container a:hover svg { transform: scale(1.1); }
        #desktop-sidebar-container a:active svg { transform: scale(0.95); }

        /* Header Adjustments for Desktop Sidebar */
        #desktop-sidebar-toggle-button { display: none; }
        @media (min-width: 768px) {
            #desktop-sidebar-toggle-button { display: flex; align-items: center; padding: 0.5rem; background: none; border: none; color: var(--accent-text-color); cursor: pointer; outline: none; }
            #mobile-menu-button { display: none; }
            #main-content.sidebar-open { margin-left: 240px; transition: margin-left 0.3s ease-in-out; }
            #main-content { transition: margin-left 0.3s ease-in-out; }
            header.sidebar-open { padding-left: 240px; transition: padding-left 0.3s ease-in-out; }
            header { transition: padding-left 0.3s ease-in-out; }
        }

        /* Home Loading Animation */
        #home-loading-animation { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        #home-loading-animation.hidden { display: none; }
        .fade-out { animation: fadeOut 1s ease-in-out forwards; }
        @keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }

        /* Logo Animation */
        #logo-container { display: flex; align-items: center; gap: 0.5rem; }
        #logo-text { font-size: 1.5em; font-weight: bold; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .logo-animated { animation: pulse 1.5s infinite alternate; }

        /* Mobile Sidebar Link Animation */
        #mobile-sidebar nav a { display: flex; align-items: center; gap: 0.75rem; }
        #mobile-sidebar nav a svg { width: 1.25rem; height: 1.25rem; fill: currentColor; transition: transform 0.2s ease-in-out; }
        #mobile-sidebar nav a:active svg { transform: scale(0.95); }

        /* Button Styling with Accent Colors */
        .btn-primary { background: var(--button-bg-gradient); color: white; transition: background 0.3s ease, transform 0.1s ease; }
        .btn-primary:hover { background: var(--button-bg-gradient-hover); }
        .btn-primary:active { transform: scale(0.97); }
        .btn-secondary { background-color: rgba(107, 114, 128, 0.5); color: #e0e0e0; transition: background-color 0.2s ease, transform 0.1s ease; }
        .btn-secondary:hover { background-color: rgba(107, 114, 128, 0.7); }
        .btn-secondary:active { transform: scale(0.97); }
        .btn-danger { background-color: #ef4444; color: white; transition: background-color 0.2s ease, transform 0.1s ease; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-danger:active { transform: scale(0.97); }
        .btn-warning { background-color: #f59e0b; color: white; transition: background-color 0.2s ease, transform 0.1s ease; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-warning:active { transform: scale(0.97); }
        .btn-success { background-color: #10b981; color: white; transition: background-color 0.2s ease, transform 0.1s ease; }
        .btn-success:hover { background-color: #059669; }
        .btn-success:active { transform: scale(0.97); }

        /* Input Focus Ring */
        input[type="search"]:focus, input[type="text"]:focus, input[type="color"]:focus { outline: none; box-shadow: 0 0 0 2px var(--focus-ring-color); border-color: var(--focus-ring-color) !important; /* Use important to override Tailwind */ }
        input[type="checkbox"]:focus { box-shadow: 0 0 0 2px var(--focus-ring-color); }
        input[type="checkbox"]:checked { background-color: var(--accent-color-1); border-color: var(--accent-color-1); }

        /* Notification Styling */
        #notification-message.success { background-color: rgba(16, 185, 129, 0.8); border-color: #059669; }
        #notification-message.error { background-color: rgba(239, 68, 68, 0.8); border-color: #dc2626; }

        /* About Section Styling */
        #about-view ul li { margin-bottom: 0.75rem; } /* Add spacing between list items */
        #about-view strong { color: var(--accent-text-color); } /* Use accent color for strong tags */
        #about-view .special-thanks { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(162, 155, 254, 0.2); }
    </style>
</head>
<body class="antialiased">

    <header id="app-header" class="fixed top-0 left-0 right-0 z-50 glassmorphism border-b border-gray-700/30 shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <button id="desktop-sidebar-toggle-button" title="Toggle Sidebar" class="text-[color:var(--accent-text-color)] hover:text-[color:var(--accent-text-color-hover)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                </button>
                <a href="#" onclick="navigateTo('home'); return false;" class="flex items-center space-x-2 cursor-pointer flex-shrink-0 ml-2 md:ml-0">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 gradient-text" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <div id="logo-container">
                        <h1 id="logo-text" class="logo-animated">VisionTube</h1>
                        <p class="text-xs text-gray-400">Next-gen</p>
                    </div>
                </a>
            </div>
            <div class="hidden md:flex flex-grow max-w-xl mx-4">
                <form id="search-form-desktop" class="w-full flex">
                    <input type="search" id="search-input-desktop" placeholder="Cari video..." class="flex-grow px-4 py-2 rounded-l-lg bg-gray-800/50 border border-gray-700 focus:border-[var(--focus-ring-color)] focus:ring-0 text-white placeholder-gray-400">
                    <button type="submit" class="px-4 py-2 btn-primary rounded-r-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></button>
                </form>
            </div>
             <button id="mobile-menu-button" class="md:hidden text-[color:var(--accent-text-color)] hover:text-[color:var(--accent-text-color-hover)] focus:outline-none ml-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></button>
        </div>
    </header>

    <aside id="desktop-sidebar-container">
        <nav class="flex flex-col space-y-2">
            <a href="#" onclick="navigateTo('home'); return false;"> <svg viewBox="0 0 24 24"><path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z"></path></svg> <span>Trending</span> </a>
            <a href="#" onclick="navigateTo('recently-viewed'); return false;"> <svg viewBox="0 0 24 24"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"></path></svg> <span>Terakhir Dilihat</span> </a>
            <a href="#" onclick="navigateTo('playlists'); return false;"> <svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 10h11v2H3zm0-4h11v2H3zm0 8h7v2H3zm13-1v8l6-4z"></path></svg> <span>Playlist Saya</span> </a>
            <a href="#" onclick="navigateTo('settings'); return false;"> <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.83c.09-.23.13-.48.13-.73v-2.92c0-.42-.25-.8-.69-.95l-2.18-.83c-.3-.12-.62-.19-.95-.19-.32 0-.64.07-.95.19l-2.18.83c-.44.15-.69.53-.69.95v2.92c0 .25.04.5.13.73l2.11 1.83c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.83c-.09.23-.13.48-.13.73v2.92c0 .42.25.8.69.95l2.18.83c.3.12.62.19.95.19.32 0 .64-.07.95-.19l2.18-.83c.44-.15.69-.53.69-.95v-2.92c0-.25-.04-.5-.13-.73l-2.11-1.83zM12 15.17c-1.79 0-3.23-1.44-3.23-3.23s1.44-3.23 3.23-3.23 3.23 1.44 3.23 3.23-1.44 3.23-3.23 3.23z"></path></svg> <span>Setelan</span> </a>
            <a href="#" onclick="navigateTo('about'); return false;"> <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-6h2v6zm0-8h-2V7h2v4z"></path></svg> <span>Tentang</span> </a>
        </nav>
    </aside>

    <aside id="mobile-sidebar" class="fixed top-0 right-0 h-full w-64 glassmorphism border-l border-gray-700/30 shadow-lg z-[70] pt-20 px-4 transform translate-x-full md:hidden">
        <form id="search-form-mobile" class="w-full mb-6">
            <input type="search" id="search-input-mobile" placeholder="Cari video..." class="w-full px-3 py-2 rounded-md mb-2 bg-gray-800/70 border border-gray-700 focus:border-[var(--focus-ring-color)] focus:ring-0 text-white placeholder-gray-400 text-sm">
            <button type="submit" class="w-full px-3 py-2 btn-primary rounded-md text-sm flex items-center justify-center"> <svg class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg> Cari </button>
        </form>
        <nav class="flex flex-col space-y-2">
             <a href="#" onclick="navigateTo('home'); closeSidebar(); return false;" class="text-gray-200 hover:text-[color:var(--accent-text-color)] hover:bg-gray-700/50 transition duration-200 py-2 px-2 rounded"> <svg viewBox="0 0 24 24"><path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z"></path></svg> <span>Trending</span> </a>
             <a href="#" onclick="navigateTo('recently-viewed'); closeSidebar(); return false;" class="text-gray-200 hover:text-[color:var(--accent-text-color)] hover:bg-gray-700/50 transition duration-200 py-2 px-2 rounded"> <svg viewBox="0 0 24 24"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"></path></svg> <span>Terakhir Dilihat</span> </a>
             <a href="#" onclick="navigateTo('playlists'); closeSidebar(); return false;" class="text-gray-200 hover:text-[color:var(--accent-text-color)] hover:bg-gray-700/50 transition duration-200 py-2 px-2 rounded"> <svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 10h11v2H3zm0-4h11v2H3zm0 8h7v2H3zm13-1v8l6-4z"></path></svg> <span>Playlist Saya</span> </a>
             <a href="#" onclick="navigateTo('settings'); closeSidebar(); return false;" class="text-gray-200 hover:text-[color:var(--accent-text-color)] hover:bg-gray-700/50 transition duration-200 py-2 px-2 rounded"> <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.83c.09-.23.13-.48.13-.73v-2.92c0-.42-.25-.8-.69-.95l-2.18-.83c-.3-.12-.62-.19-.95-.19-.32 0-.64.07-.95.19l-2.18.83c-.44.15-.69.53-.69.95v2.92c0 .25.04.5.13.73l2.11 1.83c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.83c-.09.23-.13.48-.13.73v2.92c0 .42.25.8.69.95l2.18.83c.3.12.62.19.95.19.32 0 .64-.07.95-.19l2.18-.83c.44-.15.69-.53.69-.95v-2.92c0-.25-.04-.5-.13-.73l-2.11-1.83zM12 15.17c-1.79 0-3.23-1.44-3.23-3.23s1.44-3.23 3.23-3.23 3.23 1.44 3.23 3.23-1.44 3.23-3.23 3.23z"></path></svg> <span>Setelan</span> </a>
             <a href="#" onclick="navigateTo('about'); closeSidebar(); return false;" class="text-gray-200 hover:text-[color:var(--accent-text-color)] hover:bg-gray-700/50 transition duration-200 py-2 px-2 rounded"> <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-6h2v6zm0-8h-2V7h2v4z"></path></svg> <span>Tentang</span> </a>
        </nav>
    </aside>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-[65] hidden md:hidden" onclick="closeSidebar()"></div>

    <main id="main-content" class="container mx-auto px-4 pt-24 pb-8 relative md:ml-0">
        <div id="trending-view"> <div id="home-loading-animation" class="hidden"><div class="loader inline-block"></div><p class="mt-3 text-[color:var(--accent-text-color)]">Memuat video trending...</p></div> <h2 class="text-2xl font-semibold mb-6 gradient-text">Lagi Trending di Indonesia 🔥</h2> <div id="video-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-6"> <div id="trending-loading-placeholder" class="col-span-full text-center py-10 hidden"><div class="loader inline-block"></div><p class="mt-3 text-[color:var(--accent-text-color)]">Lagi ngambil video trending...</p></div> </div> <div id="trending-load-more-container" class="text-center mt-8 hidden"> <button id="trending-load-more-button" class="px-6 py-2 rounded-lg btn-primary">Muat Lebih Banyak</button> </div> </div>
         <div id="watch-view" class="hidden"> <div class="flex flex-col lg:flex-row gap-6"> <div class="lg:w-2/3"> <div id="youtube-player-container" class="mb-4 glassmorphism p-1 aspect-video bg-black rounded-lg shadow-lg"><div id="youtube-player"></div></div> <div id="video-details" class="glassmorphism p-4 rounded-lg"> <div class="flex justify-between items-start mb-2"> <h1 id="video-title" class="text-xl md:text-2xl font-semibold text-white flex-1 mr-4">Judul...</h1> <button id="save-video-button" onclick="openSaveVideoModal()" class="flex-shrink-0 bg-gradient-to-r from-blue-500 to-[color:var(--accent-color-2)] hover:from-blue-600 hover:to-[color:var(--accent-color-2-hover)] text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center space-x-1.5 transition duration-200" title="Simpan ke Playlist"> <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg> <span>Simpan</span> </button> </div> <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 text-sm text-gray-400"><p id="video-uploader" class="mb-1 sm:mb-0">Channel...</p><p id="video-stats">Views...</p></div> <hr class="border-gray-700/50 my-3"> <p id="video-description" class="text-sm text-gray-300 whitespace-pre-wrap max-h-60 overflow-y-auto">Deskripsi...</p> </div> </div> <div class="lg:w-1/3"> <h3 class="text-lg font-semibold mb-4 gradient-text">Video Terkait</h3> <div id="related-videos" class="space-y-3"><p class="text-sm text-gray-400">Fitur terkait belum ada.</p></div> </div> </div> </div>
         <div id="search-view" class="hidden"> <h2 class="text-2xl font-semibold mb-6">Hasil Pencarian: "<span id="search-query-display" class="gradient-text"></span>"</h2> <div id="search-results-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-6"></div> <div id="search-loading-indicator" class="text-center py-6 hidden"><div class="loader inline-block"></div><p class="mt-2 text-[color:var(--accent-text-color)]">Memuat...</p></div> <p id="search-no-results" class="text-center text-gray-400 py-6 hidden">Yah, nggak nemu 😥.</p> </div>
         <div id="recently-viewed-view" class="hidden"> <h2 class="text-2xl font-semibold mb-6 gradient-text">Terakhir Dilihat ⏱️</h2> <div id="recently-viewed-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-6"></div> <p id="recently-viewed-empty" class="text-center text-gray-400 py-10 hidden">Belum ada riwayat tontonan 🚀</p> </div>
         <div id="playlists-view" class="hidden"> <div class="flex justify-between items-center mb-6"> <h2 class="text-2xl font-semibold gradient-text">Playlist Saya 📚</h2> <button onclick="openCreatePlaylistModal()" class="px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-1.5 btn-success"> <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg> <span>Buat Playlist Baru</span> </button> </div> <div id="playlists-list" class="space-y-4"></div> <p id="playlists-empty" class="text-center text-gray-400 py-10 hidden">Belum punya playlist ✨</p> </div>
         <div id="playlist-detail-view" class="hidden"> <div class="flex items-center mb-6"> <button onclick="navigateTo('playlists')" class="text-[color:var(--accent-text-color)] hover:text-white mr-3 p-1 rounded-full hover:bg-gray-700/50 transition duration-200" title="Kembali"> <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg> </button> <h2 id="playlist-detail-name" class="text-2xl font-semibold gradient-text">Playlist...</h2> </div> <div id="playlist-videos-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-6"></div> <p id="playlist-videos-empty" class="text-center text-gray-400 py-10 hidden">Playlist ini kosong 👀</p> </div>

        <div id="about-view" class="hidden glassmorphism p-6 rounded-lg max-w-3xl mx-auto">
             <h2 class="text-2xl font-semibold mb-6 gradient-text">Tentang VisionTube ✨</h2>
            <p class="mb-4 text-gray-300">Yo, Wazzup! 👋 Selamat datang di VisionTube, tempat nongkrong baru buat nonton YouTube dengan gaya paling kece abad ini! 😎 Kita sulap pengalaman nontonmu jadi lebih asik, mulus, dan pastinya... beda dari yang lain! 😉</p>
            <p class="mb-6 text-gray-300">Penasaran ada apa aja di sini? Cekidot fitur-fitur andalan VisionTube:</p>
            <ul class="list-disc list-inside mb-6 text-gray-300 space-y-3">
                <li><strong>Interface Next-Gen</strong> ✨: Tampilannya? Beuh! Kayak liat masa depan, tapi lebih adem di mata dan gampang dipake. Dijamin betah scroll seharian sampe lupa waktu! 😎 (Warning: bisa bikin nagih!)</li>
                <li><strong>Trending Langsung (ID)</strong> 🔥: Gak bakal FOMO (Fear Of Missing Out) lagi! Langsung intip video paling viral se-Indonesia Raya. Update terus, biar kamu tetep jadi anak paling gaul di tongkrongan! 🇮🇩</li>
                <li><strong>Pencarian YouTube Sakti</strong> 🔍: Nyari video apa aja? Tinggal ketik! Kayak punya jin pribadi, tapi khusus buat nyari video YouTube. *Cring!* Langsung ketemu! ✨ (Jin-nya lagi cuti kalo API error ya 😜 Maap!)</li>
                <li><strong>Terakhir Dilihat (Anti Amnesia!)</strong> ⏱️: Lupa tadi nonton video apa sampe ketiduran? Tenang! Ada contekan video terakhir yang kamu buka, lengkap sama posisi terakhir kamu nonton. Gak perlu panik nyari lagi, tinggal klik, langsung lanjut! Praktis abis! 😎</li>
                <li><strong>Playlist Saya (Koleksi Pribadi!)</strong> 📚: Bikin playlist video favoritmu sendiri! Mau lagu galau 😭, tutorial masak mie instan level dewa 🍜, atau kumpulan video kucing oyen barbar 🐈? Bebaaaas! Atur sesukamu, biar koleksi videomu makin rapi!</li>
                 <li><strong>Player Resmi + Bebas Iklan!</strong> 🎉: Nonton pake player asli YouTube, tapi... *jeng jeng*... GAK ADA IKLAN GANGGU! 🥳 Nonton jadi lancar jaya tanpa jeda sponsor yang bikin kzl! Mantap jiwa! (Kecuali iklan di dalem videonya ya, itu mah bawaan dari sononya 😅)</li>
                <li><strong>Hemat Kuota API (Biar Gak Tekor!)</strong> 💡: Kita pinter loh! Untuk fitur trending, data videonya kita simpen bentar (cache), jadi nggak perlu minta data baru terus ke YouTube. Cerdas kan? 😉 Bikin web tetep ngebut tanpa boros kuota API (dan dompet 💸)!</li>
                <li><strong>Infinite Scroll (Scroll Sampe Bosen!)</strong> 🖱️👇: Males klik tombol "next page"? Sama! Di halaman pencarian, scroll aja terus ke bawah, video baru bakal muncul otomatis. Kayak feed sosmed, tapi isinya video semua! Scroll sampe jempol pegel! 😂</li>
                 <li><strong>Setelan Kustom (Gaya Kamu Banget!)</strong> ⚙️: Bosen sama tampilan gitu-gitu aja? Atur warna aksen sesukamu! Mau pake API Key YouTube punya sendiri? Bisa juga! VisionTube ngertiin kamu banget deh! 😉</li>
            </ul>

             <p class="text-red-400 text-sm font-semibold mb-4">🚨 AWAS! PERINGATAN PENTING! 🚨</p>
            <p class="mb-4 text-gray-300">Karena kita pake 'jasa' API dari Mbah YouTube, ada aturannya nih. Kita dikasih jatah kuota **10.000** permintaan per hari. Kedengeran banyak? Eits, tapi kalo dipake rame-rame bisa cepet abis juga! 🤣 Kalau tiba-tiba ada error aneh atau video nggak muncul, kemungkinan besar kuotanya lagi K.O. 💀</p>
            <p class="mb-6 text-gray-300">Tapi jangan panik! Kuota ini bakal diisi ulang tiap hari jam **2 siang (14:00 WIB)**. Jadi, kalo lagi apes, sabar aja bentar trus coba lagi yaaa~ 🙏</p>

            <div class="special-thanks">
                <h3 class="text-lg font-semibold mb-3 gradient-text">Spesial Thanks To: 🙏💖</h3>
                <ul class="list-disc list-inside text-sm text-gray-400 space-y-1">
                    <li><strong>Vercel:</strong> Makasih udah kasih tumpangan hosting gratis yang ngebut! Kalian ajiib! 🚀</li>
                    <li><strong>YouTube:</strong> Makasih API-nya, meski kuotanya terbatas, tapi tetep keren! 👍</li>
                    <li><strong>Tailwind CSS:</strong> Makasih udah bikin styling jadi gampang dan hasilnya kece parah! 💅</li>
                    <li><strong>Kamu (Iya, Kamu!):</strong> Makasih banyak udah nyobain dan pake VisionTube! Kehadiranmu bikin project ini makin berarti! Lop yu pull! ❤️😊</li>
                </ul>
            </div>
        </div>

        <div id="settings-view" class="hidden glassmorphism p-6 rounded-lg max-w-md mx-auto">
            <h2 class="text-2xl font-semibold mb-6 gradient-text">Setelan VisionTube ⚙️</h2>
            <div class="mb-6 border-b border-gray-700/50 pb-6"> <h3 class="text-lg font-semibold mb-3 text-white">Aksen Warna</h3> <div class="grid grid-cols-2 gap-4"> <div> <label for="accent-color-picker-1" class="block text-gray-300 text-sm mb-1">Warna Aksen 1:</label> <input type="color" id="accent-color-picker-1" class="w-full h-10 rounded-lg border-0 bg-gray-800 cursor-pointer p-1"> </div> <div> <label for="accent-color-picker-2" class="block text-gray-300 text-sm mb-1">Warna Aksen 2:</label> <input type="color" id="accent-color-picker-2" class="w-full h-10 rounded-lg border-0 bg-gray-800 cursor-pointer p-1"> </div> </div> <button id="reset-colors-button" class="px-4 py-2 rounded-lg text-sm mt-3 btn-secondary w-full">Reset Warna Default</button> <p class="text-xs text-gray-400 mt-1">Pilih dua warna aksen favoritmu!</p> </div>
            <div class="mb-6 border-b border-gray-700/50 pb-6"> <h3 class="text-lg font-semibold mb-3 text-white">API YouTube Kustom</h3> <label for="custom-api-key" class="block text-gray-300 text-sm mb-1">Kunci API Anda:</label> <input type="text" id="custom-api-key" placeholder="Masukkan API Key YouTube (opsional)" class="w-full px-3 py-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-[var(--focus-ring-color)] focus:ring-0 text-white placeholder-gray-400 text-sm"> <button id="save-api-key-button" class="px-4 py-2 rounded-lg text-sm mt-2 btn-primary w-full">Simpan API Key</button> <p class="text-xs text-gray-400 mt-1">Kosongkan untuk pakai API Key default.</p> </div>
            <div class="mb-4"> <h3 class="text-lg font-semibold mb-3 text-white">Data & Cache</h3> <button id="clear-cache-button" class="px-4 py-2 rounded-lg text-sm mb-2 btn-warning w-full">Bersihkan Cache Trending</button> <button id="clear-all-data-button" class="px-4 py-2 rounded-lg text-sm btn-danger w-full">Hapus Semua Data Lokal</button> <p class="text-xs text-gray-400 mt-1">Hapus riwayat, playlist, setelan, cache.</p> </div>
        </div>

        <div id="loading-indicator" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[9999] hidden"><div class="loader"></div></div>
        <div id="notification-message" class="fixed bottom-4 right-4 text-white p-4 rounded-lg shadow-lg z-[9998] hidden max-w-sm glassmorphism border"> <strong id="notification-title" class="font-bold block mb-1"></strong><p id="notification-text" class="text-sm"></p> <button onclick="document.getElementById('notification-message').classList.add('hidden')" class="absolute top-2 right-2 text-gray-200 hover:text-white"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button> </div>

        <div id="save-video-modal" class="modal hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[10000]"> <div class="modal-content glassmorphism p-6 rounded-lg max-w-md w-full mx-4"> <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold gradient-text">Simpan ke Playlist</h3><button onclick="closeSaveVideoModal()" class="text-gray-400 hover:text-white">×</button></div> <div id="save-modal-video-info" class="mb-4 p-3 bg-gray-800/30 rounded-lg flex items-center space-x-3"><img id="save-modal-thumbnail" src="https://placehold.co/60x34/0f0f1a/7c5cff?text=Thumb" alt="Thumbnail" class="w-16 h-9 object-cover rounded flex-shrink-0"><div><p id="save-modal-title" class="text-sm font-medium text-white line-clamp-1">Judul...</p><p id="save-modal-channel" class="text-xs text-gray-400 line-clamp-1">Channel...</p></div></div> <form id="save-video-form"> <p class="text-sm text-gray-300 mb-2">Pilih playlist:</p><div id="save-modal-playlist-list" class="space-y-2 max-h-40 overflow-y-auto mb-4 pr-2"><p class="text-xs text-gray-400">Loading...</p></div> <div class="border-t border-gray-700/50 pt-4"><label for="new-playlist-name-modal" class="text-sm text-gray-300 block mb-1">Atau buat playlist baru:</label><div class="flex space-x-2"><input type="text" id="new-playlist-name-modal" placeholder="Nama Playlist Baru..." class="flex-grow px-3 py-1.5 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-[var(--focus-ring-color)] focus:ring-0 text-white placeholder-gray-400 text-sm"><button type="button" onclick="createNewPlaylistFromModal()" class="px-3 py-1.5 rounded-lg text-sm flex-shrink-0 btn-success">Buat</button></div></div> <div class="mt-6 flex justify-end space-x-3"><button type="button" onclick="closeSaveVideoModal()" class="px-4 py-1.5 rounded-lg btn-secondary text-sm">Batal</button><button type="submit" class="px-4 py-1.5 rounded-lg btn-primary text-sm">Selesai</button></div> </form> </div> </div>
        <div id="create-playlist-modal" class="modal hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[10000]"> <div class="modal-content glassmorphism p-6 rounded-lg max-w-sm w-full mx-4"> <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold gradient-text">Buat Playlist Baru</h3><button onclick="closeCreatePlaylistModal()" class="text-gray-400 hover:text-white">×</button></div> <form id="create-playlist-form"> <label for="new-playlist-name-main" class="text-sm text-gray-300 block mb-1">Nama Playlist:</label><input type="text" id="new-playlist-name-main" required placeholder="Contoh: Musik Favorit 🎶" class="w-full px-3 py-1.5 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-[var(--focus-ring-color)] focus:ring-0 text-white placeholder-gray-400 text-sm mb-4"> <div class="flex justify-end space-x-3"><button type="button" onclick="closeCreatePlaylistModal()" class="px-4 py-1.5 rounded-lg btn-secondary text-sm">Batal</button><button type="submit" class="px-4 py-1.5 rounded-lg btn-success text-sm">Buat Playlist</button></div> </form> </div> </div>
        <div id="rename-playlist-modal" class="modal hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[10000]"> <div class="modal-content glassmorphism p-6 rounded-lg max-w-sm w-full mx-4"> <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold gradient-text">Ubah Nama Playlist</h3><button onclick="closeRenamePlaylistModal()" class="text-gray-400 hover:text-white">×</button></div> <form id="rename-playlist-form"> <input type="hidden" id="rename-playlist-id"><label for="rename-playlist-name" class="text-sm text-gray-300 block mb-1">Nama Baru:</label><input type="text" id="rename-playlist-name" required class="w-full px-3 py-1.5 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-[var(--focus-ring-color)] focus:ring-0 text-white placeholder-gray-400 text-sm mb-4"> <div class="flex justify-end space-x-3"><button type="button" onclick="closeRenamePlaylistModal()" class="px-4 py-1.5 rounded-lg btn-secondary text-sm">Batal</button><button type="submit" class="px-4 py-1.5 rounded-lg btn-warning text-sm">Simpan</button></div> </form> </div> </div>

    <script>
        // --- Configuration ---
        const DEFAULT_YOUTUBE_API_KEY = 'AIzaSyBVBHpsUwOFOUX69sW33l4uZq51Iyz90kE'; // Default API Key
        const YOUTUBE_API_BASE_URL = 'https://www.googleapis.com/youtube/v3';
        const TRENDING_MAX_RESULTS = 20;
        const SEARCH_MAX_RESULTS = 20;
        const TRENDING_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
        const RECENTLY_VIEWED_STORAGE_KEY = 'visiontube_recently_viewed';
        const MAX_RECENTLY_VIEWED = 24;
        const PLAYLISTS_STORAGE_KEY = 'visiontube_playlists';
        const LAST_SEEN_STORAGE_PREFIX = 'visiontube_last_seen_'; // Prefix for last seen position keys
        const CUSTOM_API_KEY_STORAGE_KEY = 'visiontube_custom_api_key';
        const ACCENT_COLOR_1_STORAGE_KEY = 'visiontube_accent_color_1'; // Key for accent color 1
        const ACCENT_COLOR_2_STORAGE_KEY = 'visiontube_accent_color_2'; // Key for accent color 2
        const DEFAULT_ACCENT_COLOR_1 = '#a29bfe'; // Default accent color 1
        const DEFAULT_ACCENT_COLOR_2 = '#7c5cff'; // Default accent color 2
        const SAVE_POSITION_INTERVAL = 1000; // Save position every 1 second (1000ms)

        // --- State Variables ---
        let currentView = 'home';
        let currentVideoId = null;
        let currentVideoDataForSave = null;
        let currentPlaylistId = null;
        let currentSearchQuery = '';
        let currentSearchPageToken = null;
        let currentTrendingPageToken = null;
        let isLoadingSearch = false;
        let isLoadingTrending = false;
        let ytPlayer = null;
        let videoIdToLoad = null;
        let cachedTrendingData = null;
        let trendingCacheTimestamp = 0;
        let isFullscreen = false;
        let savePositionIntervalId = null; // Interval ID for saving position

        // --- DOM Elements ---
        // (References including settings and new notification elements)
        const notificationMessage = document.getElementById('notification-message');
        const notificationTitle = document.getElementById('notification-title');
        const notificationText = document.getElementById('notification-text');
        const mainContent = document.getElementById('main-content');
        const appHeader = document.getElementById('app-header'); // Header element
        const trendingView = document.getElementById('trending-view');
        const watchView = document.getElementById('watch-view');
        const searchView = document.getElementById('search-view');
        const aboutView = document.getElementById('about-view');
        const recentlyViewedView = document.getElementById('recently-viewed-view');
        const playlistsView = document.getElementById('playlists-view');
        const playlistDetailView = document.getElementById('playlist-detail-view');
        const settingsView = document.getElementById('settings-view');
        const videoGrid = document.getElementById('video-grid');
        const trendingLoadingPlaceholder = document.getElementById('trending-loading-placeholder');
        const trendingLoadMoreContainer = document.getElementById('trending-load-more-container');
        const trendingLoadMoreButton = document.getElementById('trending-load-more-button');
        const searchResultsGrid = document.getElementById('search-results-grid');
        const searchLoadingIndicator = document.getElementById('search-loading-indicator');
        const searchNoResults = document.getElementById('search-no-results');
        const recentlyViewedGrid = document.getElementById('recently-viewed-grid');
        const recentlyViewedEmpty = document.getElementById('recently-viewed-empty');
        const playlistsList = document.getElementById('playlists-list');
        const playlistsEmpty = document.getElementById('playlists-empty');
        const playlistDetailName = document.getElementById('playlist-detail-name');
        const playlistVideosGrid = document.getElementById('playlist-videos-grid');
        const playlistVideosEmpty = document.getElementById('playlist-videos-empty');
        const youtubePlayerContainer = document.getElementById('youtube-player-container');
        const youtubePlayerDiv = document.getElementById('youtube-player');
        const videoTitle = document.getElementById('video-title');
        const videoUploader = document.getElementById('video-uploader');
        const videoStats = document.getElementById('video-stats');
        const videoDescription = document.getElementById('video-description');
        const saveVideoButton = document.getElementById('save-video-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const searchFormDesktop = document.getElementById('search-form-desktop');
        const searchInputDesktop = document.getElementById('search-input-desktop');
        const searchFormMobile = document.getElementById('search-form-mobile');
        const searchInputMobile = document.getElementById('search-input-mobile');
        const searchQueryDisplay = document.getElementById('search-query-display');
        const saveVideoModal = document.getElementById('save-video-modal');
        const saveModalPlaylistList = document.getElementById('save-modal-playlist-list');
        const saveModalThumbnail = document.getElementById('save-modal-thumbnail');
        const saveModalTitle = document.getElementById('save-modal-title');
        const saveModalChannel = document.getElementById('save-modal-channel');
        const saveVideoForm = document.getElementById('save-video-form');
        const newPlaylistNameModalInput = document.getElementById('new-playlist-name-modal');
        const createPlaylistModal = document.getElementById('create-playlist-modal');
        const createPlaylistForm = document.getElementById('create-playlist-form');
        const newPlaylistNameMainInput = document.getElementById('new-playlist-name-main');
        const renamePlaylistModal = document.getElementById('rename-playlist-modal');
        const renamePlaylistForm = document.getElementById('rename-playlist-form');
        const renamePlaylistIdInput = document.getElementById('rename-playlist-id');
        const renamePlaylistNameInput = document.getElementById('rename-playlist-name');
        const desktopSidebarContainer = document.getElementById('desktop-sidebar-container');
        const desktopSidebarToggleButton = document.getElementById('desktop-sidebar-toggle-button');
        const homeLoadingAnimation = document.getElementById('home-loading-animation');
        // Settings elements
        const clearAllDataButton = document.getElementById('clear-all-data-button');
        const clearCacheButton = document.getElementById('clear-cache-button');
        const customApiKeyInput = document.getElementById('custom-api-key');
        const saveApiKeyButton = document.getElementById('save-api-key-button');
        const accentColorPicker1 = document.getElementById('accent-color-picker-1');
        const accentColorPicker2 = document.getElementById('accent-color-picker-2');
        const resetColorsButton = document.getElementById('reset-colors-button');


        // --- YouTube IFrame Player API Functions ---
        function onYouTubeIframeAPIReady() { console.log("YT API Ready."); if (videoIdToLoad) { createPlayer(videoIdToLoad); } }
        function createPlayer(videoId, startSeconds = 0) {
            console.log("Creating player:", videoId, "Start:", startSeconds);
            if (savePositionIntervalId) { clearInterval(savePositionIntervalId); savePositionIntervalId = null; }
            if (ytPlayer && typeof ytPlayer.destroy === 'function') { try { ytPlayer.destroy(); } catch (e) { console.warn("Destroy player error:", e); } ytPlayer = null; }
            ytPlayer = new YT.Player('youtube-player', {
                height: '100%', width: '100%', videoId: videoId,
                playerVars: { 'playsinline': 1, 'autoplay': 1, 'start': Math.floor(startSeconds) },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange, 'onError': onPlayerError }
            });
        }
        function onPlayerReady(event) {
            console.log("Player Ready.");
            if (videoIdToLoad && event.target && typeof event.target.loadVideoById === 'function') {
                const startAt = parseFloat(getLastSeenPosition(videoIdToLoad) || '0');
                console.log("Loading queued video in onReady:", videoIdToLoad, "Start:", startAt);
                event.target.loadVideoById({ videoId: videoIdToLoad, startSeconds: Math.floor(startAt) });
                videoIdToLoad = null;
            }
             setTimeout(() => { if (event.target && typeof event.target.playVideo === 'function') event.target.playVideo(); }, 150); // Slightly longer delay maybe needed
        }
        function onPlayerStateChange(event) {
            const videoId = currentVideoId;
            if (!videoId) return;

            if (event.data === YT.PlayerState.PLAYING) {
                console.log("Player playing:", videoId);
                if (savePositionIntervalId) clearInterval(savePositionIntervalId);
                savePositionIntervalId = setInterval(() => {
                    if (ytPlayer && typeof ytPlayer.getCurrentTime === 'function') {
                        const currentTime = ytPlayer.getCurrentTime();
                        saveLastSeenPosition(videoId, currentTime);
                    }
                }, SAVE_POSITION_INTERVAL);
                if (currentVideoDataForSave && currentVideoDataForSave.videoId === videoId) {
                    addRecentlyViewed(currentVideoDataForSave); // Add to history on play start
                }
            } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                console.log("Player paused/ended:", videoId);
                if (savePositionIntervalId) { clearInterval(savePositionIntervalId); savePositionIntervalId = null; }
                if (ytPlayer && typeof ytPlayer.getCurrentTime === 'function') {
                    const currentTime = ytPlayer.getCurrentTime();
                    const duration = ytPlayer.getDuration ? ytPlayer.getDuration() : 0;
                    if (event.data === YT.PlayerState.ENDED || (duration > 0 && currentTime >= duration - 1.5)) {
                         console.log("Video ended, removing last seen position.");
                         localStorage.removeItem(LAST_SEEN_STORAGE_PREFIX + videoId);
                    } else {
                        console.log("Final save on pause:", videoId, currentTime);
                        saveLastSeenPosition(videoId, currentTime);
                    }
                }
            } else if (event.data === YT.PlayerState.BUFFERING) {
                 console.log("Player buffering:", videoId);
                 // Stop interval during buffering to avoid saving inaccurate times?
                 // if (savePositionIntervalId) { clearInterval(savePositionIntervalId); savePositionIntervalId = null; }
            }
        }
        function onPlayerError(event) { console.error("Player Error:", event.data); let msg = `Player Error: Kode ${event.data}.`; /* ... error mapping ... */ showError(msg + " Video mungkin dibatasi."); if (savePositionIntervalId) { clearInterval(savePositionIntervalId); savePositionIntervalId = null; } }
        function loadVideoIntoPlayer(videoId) {
            if (!videoId) return;
            currentVideoId = videoId;
            console.log("Loading video:", videoId);
            if (savePositionIntervalId) { clearInterval(savePositionIntervalId); savePositionIntervalId = null; }
            if (typeof YT === 'undefined' || !YT.Player) { console.log("API not ready, queuing:", videoId); videoIdToLoad = videoId; return; }
            const startAt = parseFloat(getLastSeenPosition(videoId) || '0');
            console.log(`Attempting to start ${videoId} at ${startAt} seconds.`);
            if (ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
                console.log("Player exists, loading video with start time.");
                try { ytPlayer.loadVideoById({ videoId: videoId, startSeconds: Math.floor(startAt) }); }
                catch (e) { console.error("Error loading video, recreating:", e); createPlayer(videoId, startAt); }
            } else { console.log("Player invalid/not ready, creating:", videoId, "Start:", startAt); createPlayer(videoId, startAt); }
        }

        // --- Last Seen Functions ---
        function getLastSeenPosition(videoId) { if (!videoId) return null; return localStorage.getItem(LAST_SEEN_STORAGE_PREFIX + videoId); }
        function saveLastSeenPosition(videoId, currentTime) { if (videoId && typeof currentTime === 'number' && currentTime >= 0) { localStorage.setItem(LAST_SEEN_STORAGE_PREFIX + videoId, currentTime.toString()); } }

        // --- Recently Viewed Functions ---
        function getRecentlyViewed() { try { const s = localStorage.getItem(RECENTLY_VIEWED_STORAGE_KEY); return s ? JSON.parse(s) : []; } catch (e) { console.error(e); return []; } }
        function saveRecentlyViewed(v) { try { localStorage.setItem(RECENTLY_VIEWED_STORAGE_KEY, JSON.stringify(v)); } catch (e) { console.error(e); showError("Gagal simpan riwayat."); } }
        function addRecentlyViewed(vd) { if (!vd || !vd.videoId) return; let v = getRecentlyViewed(); const existingIndex = v.findIndex(i => i.videoId === vd.videoId); if (existingIndex > -1) v.splice(existingIndex, 1); v.unshift({...vd, lastViewed: Date.now() }); v = v.slice(0, MAX_RECENTLY_VIEWED); saveRecentlyViewed(v); } // Position saved separately
        function loadRecentlyViewed() { console.log("Loading recent..."); const v = getRecentlyViewed(); recentlyViewedGrid.innerHTML = ''; if (v.length === 0) { recentlyViewedEmpty.classList.remove('hidden'); recentlyViewedGrid.classList.add('hidden'); } else { recentlyViewedEmpty.classList.add('hidden'); recentlyViewedGrid.classList.remove('hidden'); v.forEach(i => recentlyViewedGrid.appendChild(createRecentlyViewedCard(i))); } }

        // --- Playlist Functions ---
        // (Unchanged logic)
        function getPlaylists() { try { const s = localStorage.getItem(PLAYLISTS_STORAGE_KEY); return s ? JSON.parse(s) : {}; } catch (e) { console.error(e); return {}; } }
        function savePlaylists(p) { try { localStorage.setItem(PLAYLISTS_STORAGE_KEY, JSON.stringify(p)); } catch (e) { console.error(e); showError("Gagal simpan playlist."); } }
        function createPlaylist(name) { const p = getPlaylists(); const id = `pl_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`; const tName = name.trim(); if (!tName) { showError("Nama playlist kosong!"); return null; } const exists = Object.values(p).some(i => i.name.toLowerCase() === tName.toLowerCase()); if (exists) { showError(`Playlist "${tName}" sudah ada!`); return null; } p[id] = { id: id, name: tName, createdAt: Date.now(), videos: [] }; savePlaylists(p); console.log("Playlist created:", id, tName); return id; }
        function renamePlaylist(id, newName) { const p = getPlaylists(); const tName = newName.trim(); if (!tName) { showError("Nama baru kosong!"); return false; } if (p[id]) { const exists = Object.values(p).some(i => i.id !== id && i.name.toLowerCase() === tName.toLowerCase()); if (exists) { showError(`Nama "${tName}" sudah dipakai!`); return false; } p[id].name = tName; savePlaylists(p); console.log("Playlist renamed:", id, tName); return true; } else { showError("Playlist tak ditemukan."); return false; } }
        function deletePlaylist(id) { const p = getPlaylists(); if (p[id]) { if (confirm(`Yakin hapus playlist "${p[id].name}"?`)) { delete p[id]; savePlaylists(p); console.log("Playlist deleted:", id); if (currentView === 'playlists') loadPlaylists(); showSuccessMessage("Playlist berhasil dihapus."); } } else { showError("Playlist tak ditemukan."); } }
        function addVideoToPlaylists(ids, vd) { if (!vd || !vd.videoId) { showError("Data video tak valid."); return; } if (!ids || ids.length === 0) { showError("Pilih playlist tujuan."); return; } const p = getPlaylists(); let count = 0; const vta = { ...vd, addedAt: Date.now() }; ids.forEach(id => { if (p[id]) { const exists = p[id].videos.some(v => v.videoId === vd.videoId); if (!exists) { p[id].videos.unshift(vta); count++; } } }); if (count > 0) { savePlaylists(p); console.log(`Video added to ${count} playlist(s).`); showSuccessMessage(`Video ditambah ke ${count} playlist! ✨`); } else { showError("Video sudah ada di playlist terpilih."); } closeSaveVideoModal(); }
        function removeVideoFromPlaylist(plId, vId) { const p = getPlaylists(); if (p[plId]) { const len = p[plId].videos.length; p[plId].videos = p[plId].videos.filter(v => v.videoId !== vId); if (p[plId].videos.length < len) { savePlaylists(p); console.log(`Video ${vId} removed from ${plId}`); if (currentView === 'playlist-detail' && currentPlaylistId === plId) loadPlaylistDetails(plId); showSuccessMessage("Video dihapus dari playlist."); } } else { showError("Playlist tak ditemukan."); } }
        function loadPlaylists() { console.log("Loading playlists..."); const p = getPlaylists(); const arr = Object.values(p).sort((a, b) => b.createdAt - a.createdAt); playlistsList.innerHTML = ''; if (arr.length === 0) { playlistsEmpty.classList.remove('hidden'); playlistsList.classList.add('hidden'); } else { playlistsEmpty.classList.add('hidden'); playlistsList.classList.remove('hidden'); arr.forEach(i => playlistsList.appendChild(createPlaylistItem(i))); } }
        function loadPlaylistDetails(id) { console.log("Loading playlist details:", id); const p = getPlaylists(); const pl = p[id]; if (!pl) { showError("Playlist tak ditemukan!"); navigateTo('playlists'); return; } currentPlaylistId = id; playlistDetailName.textContent = pl.name; playlistVideosGrid.innerHTML = ''; if (pl.videos.length === 0) { playlistVideosEmpty.classList.remove('hidden'); playlistVideosGrid.classList.add('hidden'); } else { playlistVideosEmpty.classList.add('hidden'); playlistVideosGrid.classList.remove('hidden'); const sorted = [...pl.videos].sort((a, b) => b.addedAt - a.addedAt); sorted.forEach(v => playlistVideosGrid.appendChild(createPlaylistVideoCard(v, id))); } }

        // --- API Functions ---
        async function fetchFromYouTubeAPI(endpoint, params) {
            const url = new URL(`${YOUTUBE_API_BASE_URL}${endpoint}`);
            const customKey = localStorage.getItem(CUSTOM_API_KEY_STORAGE_KEY);
            params.key = customKey || DEFAULT_YOUTUBE_API_KEY;
            Object.keys(params).forEach(key => { if (params[key] !== null && params[key] !== undefined) { url.searchParams.append(key, params[key]); } });
            console.log(`Fetching: ${endpoint}`, params.key === customKey ? '(Custom Key)' : '(Default Key)');
            const isInitial = (endpoint === '/videos' && params.id) || (endpoint === '/search' && !params.pageToken) || (endpoint === '/videos' && params.chart === 'mostPopular' && !params.pageToken);
            if (isInitial) showLoading();
            try {
                const r = await fetch(url.toString()); const d = await r.json();
                if (!r.ok) { let msg = `API Error (${r.status})`; if (d.error && d.error.message) { msg += `: ${d.error.message}`; if (d.error.errors && d.error.errors.some(e => e.reason === 'quotaExceeded')) msg = "Kuota API habis! 💀 Coba lagi besok (14:00 WIB)."; } else msg += `: ${r.statusText || 'Unknown'}`; throw new Error(msg); }
                if (isInitial) hideLoading(); return d;
            } catch (e) { console.error(`API Fetch Error (${endpoint}):`, e); showError(`${e.message}`); hideLoading(); if (endpoint === '/videos' && params.chart === 'mostPopular') { isLoadingTrending = false; if(trendingLoadMoreButton) { trendingLoadMoreButton.disabled=false; trendingLoadMoreButton.innerHTML = 'Muat Lebih Banyak';} trendingLoadingPlaceholder.classList.add('hidden'); } else if (endpoint === '/search') { isLoadingSearch = false; searchLoadingIndicator.classList.add('hidden'); } return null; }
        }
        async function loadTrendingVideos(pageToken = null, forceRefresh = false) { if (!pageToken && !forceRefresh && cachedTrendingData && (Date.now() - trendingCacheTimestamp < TRENDING_CACHE_DURATION)) { console.log("Using cached trending."); videoGrid.innerHTML = ''; cachedTrendingData.items.forEach(i => videoGrid.appendChild(createVideoCard(i))); currentTrendingPageToken = cachedTrendingData.nextPageToken; trendingLoadMoreContainer.classList.toggle('hidden', !currentTrendingPageToken); trendingLoadingPlaceholder.classList.add('hidden'); return; } if (isLoadingTrending) return; isLoadingTrending = true; if (!pageToken) { videoGrid.innerHTML = ''; trendingLoadingPlaceholder.classList.remove('hidden'); trendingLoadMoreContainer.classList.add('hidden'); } else { trendingLoadMoreButton.innerHTML = '<div class="loader inline-block w-5 h-5 border-3"></div>'; trendingLoadMoreButton.disabled = true; } const params = { part: 'snippet,contentDetails,statistics', chart: 'mostPopular', regionCode: 'ID', maxResults: TRENDING_MAX_RESULTS, pageToken: pageToken }; console.log("Fetching trending...", params); const data = await fetchFromYouTubeAPI('/videos', params); trendingLoadingPlaceholder.classList.add('hidden'); if (pageToken && trendingLoadMoreButton) { trendingLoadMoreButton.innerHTML = 'Muat Lebih Banyak'; trendingLoadMoreButton.disabled = false; } if (data && data.items && Array.isArray(data.items)) { if (!pageToken) { console.log("Caching trending."); cachedTrendingData = { items: [...data.items], nextPageToken: data.nextPageToken }; trendingCacheTimestamp = Date.now(); videoGrid.innerHTML = ''; } data.items.forEach(i => videoGrid.appendChild(createVideoCard(i))); currentTrendingPageToken = data.nextPageToken; trendingLoadMoreContainer.classList.toggle('hidden', !currentTrendingPageToken); if (data.items.length === 0 && !pageToken) { videoGrid.innerHTML = '<p class="text-center text-gray-400 col-span-full py-5">Trending kosong.</p>'; cachedTrendingData = null; } } else if (!pageToken) { videoGrid.innerHTML = '<p class="text-center text-red-400 col-span-full py-5">Gagal load trending.</p>'; cachedTrendingData = null; } isLoadingTrending = false; }
        async function loadVideoDetails(videoId) { videoTitle.textContent='Loading...'; videoUploader.textContent='Loading...'; videoStats.textContent='Loading...'; videoDescription.textContent='Loading...'; currentVideoDataForSave=null; const params={part:'snippet,statistics,contentDetails',id:videoId}; const data=await fetchFromYouTubeAPI('/videos',params); if(data&&data.items&&data.items.length>0){ const v=data.items[0]; const s=v.snippet; const st=v.statistics; const t=s.title||'N/A'; const c=s.channelTitle||'N/A'; const th=s.thumbnails?.medium?.url||s.thumbnails?.default?.url; videoTitle.textContent=t; videoUploader.textContent=c?`Oleh: ${c}`:'N/A'; const vt=st?.viewCount?formatViews(st.viewCount):'N/A'; const p=s.publishedAt?timeAgo(s.publishedAt):'?'; videoStats.textContent=`${vt} views • ${p}`; const dHtml=(s.description||'N/A').replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer" class="text-[color:var(--accent-text-color)] hover:text-[color:var(--accent-text-color-hover)] underline">$1</a>'); videoDescription.innerHTML=dHtml; currentVideoDataForSave={videoId:videoId,title:t,thumbnailUrl:th||'https://placehold.co/60x34/0f0f1a/7c5cff?text=Thumb',channelTitle:c}; /* addRecentlyViewed moved to onPlayerStateChange */ } else { videoTitle.textContent='Gagal Load'; videoUploader.textContent=''; videoStats.textContent=''; videoDescription.textContent='Video tak ditemukan.'; } }
        async function searchVideos(query, pageToken = null) { if (isLoadingSearch) return; isLoadingSearch = true; if (!pageToken) { searchResultsGrid.innerHTML = ''; searchNoResults.classList.add('hidden'); window.scrollTo(0, 0); } searchLoadingIndicator.classList.remove('hidden'); const params = { part: 'snippet', q: query, type: 'video', maxResults: SEARCH_MAX_RESULTS, pageToken: pageToken }; console.log(`Searching (token: ${pageToken})...`); const data = await fetchFromYouTubeAPI('/search', params); searchLoadingIndicator.classList.add('hidden'); if (data && data.items && Array.isArray(data.items)) { if (data.items.length === 0 && !pageToken) { searchNoResults.classList.remove('hidden'); } else if (data.items.length > 0) { searchNoResults.classList.add('hidden'); data.items.forEach(i => searchResultsGrid.appendChild(createVideoCardFromSearch(i))); } currentSearchPageToken = data.nextPageToken; if (!currentSearchPageToken) console.log("End of search results."); } else if (!pageToken) { searchResultsGrid.innerHTML = '<p class="text-center text-red-400 col-span-full py-5">Gagal cari.</p>'; searchNoResults.classList.add('hidden'); currentSearchPageToken = null; } isLoadingSearch = false; }

        // --- UI Functions ---
        function createVideoCard(videoData) { /* ... uses accent colors implicitly via CSS vars ... */ const card = document.createElement('div'); card.className = 'video-card glassmorphism overflow-hidden shadow-lg cursor-pointer flex flex-col h-full rounded-lg border border-gray-700/30 min-h-[250px] sm:min-h-[280px]'; const videoId = videoData.id; const snippet = videoData.snippet; const stats = videoData.statistics; const contentDetails = videoData.contentDetails; const title = snippet.title || 'N/A'; const uploaderName = snippet.channelTitle || 'N/A'; const thumbnailUrl = snippet.thumbnails?.medium?.url || snippet.thumbnails?.default?.url || 'https://placehold.co/320x180/0f0f1a/7c5cff?text=Thumb'; const viewsText = stats?.viewCount ? formatViews(stats.viewCount) : 'N/A'; const uploadedText = snippet.publishedAt ? timeAgo(snippet.publishedAt) : '?'; const durationText = contentDetails?.duration ? formatISO8601Duration(contentDetails.duration) : ''; card.onclick = () => navigateTo('watch', videoId); card.innerHTML = ` <div class="relative aspect-video bg-black/30"> <img src="${thumbnailUrl}" alt="${title}" class="w-full h-full object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/320x180/0f0f1a/7c5cff?text=Error';"> ${durationText ? `<span class="absolute bottom-1 right-1 bg-black/70 text-white text-xs px-1.5 py-0.5 rounded">${durationText}</span>` : ''} </div> <div class="p-3 flex flex-col flex-grow"> <h3 class="font-semibold text-sm mb-1 text-white line-clamp-2" title="${title}">${title}</h3> <p class="text-xs text-gray-400 mb-1 line-clamp-1" title="${uploaderName}">${uploaderName}</p> <p class="text-xs text-gray-500 mt-auto pt-1">${viewsText} views • ${uploadedText}</p> </div>`; return card; }
        function createVideoCardFromSearch(searchItem) { /* ... uses accent colors implicitly via CSS vars ... */ const card = document.createElement('div'); card.className = 'video-card glassmorphism overflow-hidden shadow-lg cursor-pointer flex flex-col h-full rounded-lg border border-gray-700/30 min-h-[250px] sm:min-h-[280px]'; const videoId = searchItem.id?.videoId; const snippet = searchItem.snippet; if (!videoId) return document.createDocumentFragment(); const title = snippet.title || 'N/A'; const uploaderName = snippet.channelTitle || 'N/A'; const thumbnailUrl = snippet.thumbnails?.medium?.url || snippet.thumbnails?.default?.url || 'https://placehold.co/320x180/0f0f1a/7c5cff?text=Thumb'; const uploadedText = snippet.publishedAt ? timeAgo(snippet.publishedAt) : '?'; card.onclick = () => navigateTo('watch', videoId); card.innerHTML = ` <div class="relative aspect-video bg-black/30"> <img src="${thumbnailUrl}" alt="${title}" class="w-full h-full object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/320x180/0f0f1a/7c5cff?text=Error';"> </div> <div class="p-3 flex flex-col flex-grow"> <h3 class="font-semibold text-sm mb-1 text-white line-clamp-2" title="${title}">${title}</h3> <p class="text-xs text-gray-400 mb-1 line-clamp-1" title="${uploaderName}">${uploaderName}</p> <p class="text-xs text-gray-500 mt-auto pt-1">${uploadedText}</p> </div>`; return card; }
        function createRecentlyViewedCard(videoData) { /* ... uses accent colors implicitly via CSS vars ... */ const card = document.createElement('div'); card.className = 'video-card glassmorphism overflow-hidden shadow-lg cursor-pointer flex flex-col h-full rounded-lg border border-gray-700/30 min-h-[250px] sm:min-h-[280px]'; const { videoId, title, thumbnailUrl, channelTitle, lastViewed } = videoData; const viewedText = lastViewed ? `Dilihat: ${timeAgo(lastViewed)}` : '?'; card.onclick = () => { navigateTo('watch', videoId); }; card.innerHTML = ` <div class="relative aspect-video bg-black/30"> <img src="${thumbnailUrl}" alt="${title}" class="w-full h-full object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/320x180/0f0f1a/7c5cff?text=Error';"> </div> <div class="p-3 flex flex-col flex-grow"> <h3 class="font-semibold text-sm mb-1 text-white line-clamp-2" title="${title}">${title}</h3> <p class="text-xs text-gray-400 mb-1 line-clamp-1" title="${channelTitle}">${channelTitle}</p> <p class="text-xs text-gray-500 mt-auto pt-1">${viewedText}</p> </div>`; return card; }
        function createPlaylistItem(playlist) { /* ... uses accent colors implicitly via CSS vars ... */ const item = document.createElement('div'); item.className = 'playlist-item glassmorphism p-4 rounded-lg flex justify-between items-center transition duration-200 border border-gray-700/30'; const count = playlist.videos?.length || 0; item.innerHTML = ` <div class="flex-1 mr-4 cursor-pointer" onclick="navigateTo('playlist-detail', '${playlist.id}')"> <h4 class="font-semibold text-white mb-1 line-clamp-1">${playlist.name}</h4> <p class="text-xs text-gray-400">${count} video</p> </div> <div class="flex space-x-2 flex-shrink-0"> <button onclick="openRenamePlaylistModal('${playlist.id}', '${escapeSingleQuotes(playlist.name)}')" class="p-1.5 rounded-md bg-yellow-600/30 hover:bg-yellow-500/40 text-yellow-300 transition duration-200" title="Ubah Nama"> <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg> </button> <button onclick="deletePlaylist('${playlist.id}')" class="p-1.5 rounded-md bg-red-600/30 hover:bg-red-500/40 text-red-300 transition duration-200" title="Hapus"> <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg> </button> </div>`; return item; }
        function createPlaylistVideoCard(videoData, playlistId) { /* ... uses accent colors implicitly via CSS vars ... */ const card = document.createElement('div'); card.className = 'video-card glassmorphism overflow-hidden shadow-lg flex flex-col h-full rounded-lg border border-gray-700/30 min-h-[250px] sm:min-h-[280px] relative group'; const { videoId, title, thumbnailUrl, channelTitle, addedAt } = videoData; const addedText = addedAt ? `Ditambahkan: ${timeAgo(addedAt)}` : ''; const content = document.createElement('div'); content.className = 'cursor-pointer flex flex-col flex-grow'; content.onclick = () => navigateTo('watch', videoId); content.innerHTML = ` <div class="relative aspect-video bg-black/30"> <img src="${thumbnailUrl}" alt="${title}" class="w-full h-full object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/320x180/0f0f1a/7c5cff?text=Error';"> </div> <div class="p-3 flex flex-col flex-grow"> <h3 class="font-semibold text-sm mb-1 text-white line-clamp-2" title="${title}">${title}</h3> <p class="text-xs text-gray-400 mb-1 line-clamp-1" title="${channelTitle}">${channelTitle}</p> <p class="text-xs text-gray-500 mt-auto pt-1">${addedText}</p> </div>`; const removeBtn = document.createElement('button'); removeBtn.className = 'absolute top-2 right-2 p-1 rounded-full bg-red-600/70 hover:bg-red-500/90 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10'; removeBtn.title = 'Hapus dari Playlist'; removeBtn.onclick = (e) => { e.stopPropagation(); removeVideoFromPlaylist(playlistId, videoId); }; removeBtn.innerHTML = `<svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`; card.appendChild(content); card.appendChild(removeBtn); return card; }

        // --- Modal Functions ---
        // (Unchanged logic)
        function openSaveVideoModal() { if (!currentVideoDataForSave) { showError("Data video belum siap."); return; } console.log("Opening save modal:", currentVideoDataForSave.videoId); saveModalThumbnail.src = currentVideoDataForSave.thumbnailUrl; saveModalTitle.textContent = currentVideoDataForSave.title; saveModalChannel.textContent = currentVideoDataForSave.channelTitle; const p = getPlaylists(); const arr = Object.values(p).sort((a, b) => b.createdAt - a.createdAt); saveModalPlaylistList.innerHTML = ''; if (arr.length === 0) { saveModalPlaylistList.innerHTML = '<p class="text-xs text-gray-400">Belum ada playlist.</p>'; } else { arr.forEach(i => { const isChecked = i.videos.some(v => v.videoId === currentVideoDataForSave.videoId); const div = document.createElement('div'); div.className = 'flex items-center'; div.innerHTML = ` <input type="checkbox" id="pl-check-${i.id}" name="playlistSelection" value="${i.id}" class="mr-2 h-4 w-4 rounded text-[color:var(--accent-color-1)] focus:ring-[color:var(--focus-ring-color)] border-gray-600 bg-gray-700" ${isChecked ? 'checked disabled' : ''}> <label for="pl-check-${i.id}" class="text-sm ${isChecked ? 'text-gray-500' : 'text-gray-200'}">${i.name} ${isChecked ? '(sudah ada)' : ''}</label>`; saveModalPlaylistList.appendChild(div); }); } newPlaylistNameModalInput.value = ''; saveVideoModal.classList.remove('hidden'); }
        function closeSaveVideoModal() { saveVideoModal.classList.add('hidden'); }
        function createNewPlaylistFromModal() { const name = newPlaylistNameModalInput.value.trim(); if (name) { const id = createPlaylist(name); if (id) { openSaveVideoModal(); setTimeout(() => { const cb = document.getElementById(`pl-check-${id}`); if (cb) cb.checked = true; }, 50); } newPlaylistNameModalInput.value = ''; } else { showError("Masukkan nama playlist!"); } }
        saveVideoForm.addEventListener('submit', (e) => { e.preventDefault(); const sel = Array.from(e.target.elements.playlistSelection).filter(cb => cb.checked && !cb.disabled).map(cb => cb.value); if (sel.length > 0 && currentVideoDataForSave) { addVideoToPlaylists(sel, currentVideoDataForSave); } else if (sel.length === 0) { showError("Pilih playlist."); } });
        function openCreatePlaylistModal() { newPlaylistNameMainInput.value = ''; createPlaylistModal.classList.remove('hidden'); newPlaylistNameMainInput.focus(); }
        function closeCreatePlaylistModal() { createPlaylistModal.classList.add('hidden'); }
        createPlaylistForm.addEventListener('submit', (e) => { e.preventDefault(); const name = newPlaylistNameMainInput.value.trim(); if (name) { const success = createPlaylist(name); if (success) { closeCreatePlaylistModal(); loadPlaylists(); showSuccessMessage(`Playlist "${name}" dibuat! 🎉`); } } });
        function openRenamePlaylistModal(id, name) { renamePlaylistIdInput.value = id; renamePlaylistNameInput.value = name; renamePlaylistModal.classList.remove('hidden'); renamePlaylistNameInput.focus(); }
        function closeRenamePlaylistModal() { renamePlaylistModal.classList.add('hidden'); }
        renamePlaylistForm.addEventListener('submit', (e) => { e.preventDefault(); const id = renamePlaylistIdInput.value; const name = renamePlaylistNameInput.value.trim(); if (id && name) { const success = renamePlaylist(id, name); if (success) { closeRenamePlaylistModal(); loadPlaylists(); if (currentView === 'playlist-detail' && currentPlaylistId === id) loadPlaylistDetails(id); showSuccessMessage("Nama playlist diubah! 👍"); } } });

        // --- Update View logic ---
        function updateView() {
            console.log(`Updating view: ${currentView}, Playlist: ${currentPlaylistId}`);
            [trendingView, watchView, searchView, aboutView, recentlyViewedView, playlistsView, playlistDetailView, settingsView].forEach(v => v.classList.add('hidden'));
            if (currentView !== 'watch' && ytPlayer && typeof ytPlayer.stopVideo === 'function') {
                try { const state = ytPlayer.getPlayerState(); if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING) { if (currentVideoId && typeof ytPlayer.getCurrentTime === 'function') saveLastSeenPosition(currentVideoId, ytPlayer.getCurrentTime()); ytPlayer.stopVideo(); console.log("Player stopped."); } if (savePositionIntervalId) { clearInterval(savePositionIntervalId); savePositionIntervalId = null; } }
                catch(e) { console.warn("Stop player error:", e); }
            }
            switch (currentView) {
                case 'home': trendingView.classList.remove('hidden'); loadTrendingVideos(); break;
                case 'watch': watchView.classList.remove('hidden'); if (currentVideoId) { loadVideoDetails(currentVideoId); loadVideoIntoPlayer(currentVideoId); } break;
                case 'search': searchView.classList.remove('hidden'); searchQueryDisplay.textContent = currentSearchQuery; if (searchResultsGrid.innerHTML === '' && !isLoadingSearch && currentSearchQuery) searchVideos(currentSearchQuery); break;
                case 'recently-viewed': recentlyViewedView.classList.remove('hidden'); loadRecentlyViewed(); break;
                case 'playlists': playlistsView.classList.remove('hidden'); loadPlaylists(); break;
                case 'playlist-detail': playlistDetailView.classList.remove('hidden'); if (currentPlaylistId) loadPlaylistDetails(currentPlaylistId); else navigateTo('playlists'); break;
                case 'settings': settingsView.classList.remove('hidden'); loadSettings(); hideLoading(); break;
                case 'about': aboutView.classList.remove('hidden'); hideLoading(); break;
            }
            if (currentView !== 'search' || currentSearchPageToken === null) window.scrollTo(0, 0);
            // Close desktop sidebar on navigation if open
            if (desktopSidebarContainer.classList.contains('open')) { toggleDesktopSidebar(); }
        }

        // --- Navigation function ---
        function navigateTo(view, param = null) {
            console.log(`Navigating to: ${view}, Param: ${param}`);
            if (currentView === 'watch' && ytPlayer && currentVideoId && typeof ytPlayer.getCurrentTime === 'function') { const state = ytPlayer.getPlayerState(); if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.PAUSED) saveLastSeenPosition(currentVideoId, ytPlayer.getCurrentTime()); if (savePositionIntervalId) { clearInterval(savePositionIntervalId); savePositionIntervalId = null; } }
            let hash = `#${view}`;
            if (view === 'watch' && param) hash += `?v=${param}`;
            else if (view === 'search' && param) hash += `?q=${encodeURIComponent(param)}`;
            else if (view === 'playlist-detail' && param) hash += `?id=${param}`;
            else if (view === 'home') hash = '#';
            if (window.location.hash !== hash) window.location.hash = hash;
            else { console.log("Hash same, manual trigger."); handleHashChange(true); }
        }

        // --- Hash change handler ---
        function handleHashChange(isManual = false) {
            console.log(`Hash change. Hash: ${window.location.hash}, Manual: ${isManual}`);
            if (currentView === 'watch' && ytPlayer && currentVideoId && typeof ytPlayer.getCurrentTime === 'function') { const state = ytPlayer.getPlayerState(); if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.PAUSED) saveLastSeenPosition(currentVideoId, ytPlayer.getCurrentTime()); if (savePositionIntervalId) { clearInterval(savePositionIntervalId); savePositionIntervalId = null; } }
            const hash = window.location.hash; let view = 'home'; let param = null;
            if (hash.startsWith('#watch?v=')) { view = 'watch'; param = hash.substring(9); }
            else if (hash.startsWith('#search?q=')) { view = 'search'; param = decodeURIComponent(hash.substring(10)); }
            else if (hash.startsWith('#playlist-detail?id=')) { view = 'playlist-detail'; param = hash.substring(20); }
            else if (hash === '#recently-viewed') view = 'recently-viewed';
            else if (hash === '#playlists') view = 'playlists';
            else if (hash === '#settings') view = 'settings';
            else if (hash === '#about') view = 'about';
            else if (hash === '#' || hash === '') view = 'home';
            console.log(`Determined view: ${view}, Param: ${param}`); const prevQuery = currentSearchQuery; const prevView = currentView; currentView = view; currentVideoId = (view === 'watch') ? param : null; currentPlaylistId = (view === 'playlist-detail') ? param : null; currentSearchQuery = (view === 'search') ? param : ''; const newSearch = view === 'search' && (currentSearchQuery !== prevQuery || prevView !== 'search'); if (newSearch) { console.log("New search, reset state."); currentSearchPageToken = null; isLoadingSearch = false; searchResultsGrid.innerHTML = ''; }
            updateView();
            if (isManual && view === 'home') { console.log("Manual home refresh."); cachedTrendingData = null; currentTrendingPageToken = null; loadTrendingVideos(null, true); }
        }

        // --- Utility Functions ---
        function formatViews(v) { if (v === undefined || v === null || v < 0) return 'N/A'; if (v === 0) return 'No'; v = parseInt(v, 10); if (isNaN(v)) return 'N/A'; if (v >= 1e9) return (v / 1e9).toFixed(1).replace('.0', '') + ' M'; if (v >= 1e6) return (v / 1e6).toFixed(1).replace('.0', '') + ' Jt'; if (v >= 1e3) return (v / 1e3).toFixed(1).replace('.0', '') + ' Rb'; return v.toString(); }
        function timeAgo(ts) { if (!ts) return '?'; const d = new Date(ts); if (isNaN(d.getTime())) return '?'; const n = new Date(); const s = Math.floor((n - d) / 1000); if (s < 5) return "Baru saja"; let i = Math.floor(s / 31536000); if (i >= 1) return i + " thn lalu"; i = Math.floor(s / 2592000); if (i >= 1) return i + " bln lalu"; i = Math.floor(s / 86400); if (i >= 1) return i + " hr lalu"; i = Math.floor(s / 3600); if (i >= 1) return i + " jam lalu"; i = Math.floor(s / 60); if (i >= 1) return i + " mnt lalu"; return Math.floor(s) + " dtk lalu"; }
        function formatISO8601Duration(d) { if (!d) return ''; const m = d.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/); if (!m) return ''; const h = parseInt(m[1] || 0); const min = parseInt(m[2] || 0); const s = parseInt(m[3] || 0); let r = ''; if (h > 0) { r += h + ':'; r += String(min).padStart(2, '0') + ':'; } else r += min + ':'; r += String(s).padStart(2, '0'); return r; }
        function showLoading() { loadingIndicator.classList.remove('hidden'); }
        function hideLoading() { setTimeout(() => { loadingIndicator.classList.add('hidden'); }, 50); }
        function toggleSidebar() { const isOpen = !mobileSidebar.classList.contains('translate-x-full'); if (isOpen) closeSidebar(); else { mobileSidebar.classList.remove('translate-x-full'); sidebarOverlay.classList.remove('hidden'); } }
        function closeSidebar() { mobileSidebar.classList.add('translate-x-full'); sidebarOverlay.classList.add('hidden'); }
        function escapeSingleQuotes(str) { return str ? str.replace(/'/g, "\\'") : ''; }
        function formatTime(seconds) { if (isNaN(seconds) || seconds < 0) return ''; const hrs = Math.floor(seconds / 3600); const mins = Math.floor((seconds % 3600) / 60); const secs = Math.floor(seconds % 60); let result = ''; if (hrs > 0) { result += hrs + ':' + (mins < 10 ? '0' : ''); } result += mins + ':' + (secs < 10 ? '0' : ''); result += secs; return result; }
        function showNotification(message, type = 'error', duration = 5000) { console.log(`Notify (${type}):`, message); notificationText.textContent = message; notificationMessage.classList.remove('success', 'error'); if (type === 'success') { notificationTitle.textContent = 'Sukses! ✨'; notificationMessage.classList.add('success'); } else { notificationTitle.textContent = 'Waduh! 😥'; notificationMessage.classList.add('error'); } notificationMessage.classList.remove('hidden'); setTimeout(() => { notificationMessage.classList.add('hidden'); }, duration); }
        function showError(message) { showNotification(message, 'error', 7000); }
        function showSuccessMessage(message) { showNotification(message, 'success', 4000); }
        function adjustColorBrightness(hex, percent) { if (!hex || hex.length < 7) return '#ffffff'; let R = parseInt(hex.substring(1,3),16); let G = parseInt(hex.substring(3,5),16); let B = parseInt(hex.substring(5,7),16); R = parseInt(R * (100 + percent) / 100); G = parseInt(G * (100 + percent) / 100); B = parseInt(B * (100 + percent) / 100); R = (R<255)?R:255; G = (G<255)?G:255; B = (B<255)?B:255; R = Math.round(R); G = Math.round(G); B = Math.round(B); const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16)); const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16)); const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16)); return "#"+RR+GG+BB; }
        function applyAccentColors(color1, color2) { document.documentElement.style.setProperty('--accent-color-1', color1); document.documentElement.style.setProperty('--accent-color-2', color2); document.documentElement.style.setProperty('--accent-color-1-hover', adjustColorBrightness(color1, 15)); document.documentElement.style.setProperty('--accent-color-2-hover', adjustColorBrightness(color2, 15)); document.documentElement.style.setProperty('--accent-text-color', color1); document.documentElement.style.setProperty('--accent-text-color-hover', adjustColorBrightness(color1, 15)); document.documentElement.style.setProperty('--focus-ring-color', color1); }

        // --- Settings Functions ---
        function loadSettings() { const key = localStorage.getItem(CUSTOM_API_KEY_STORAGE_KEY); customApiKeyInput.value = key || ''; const c1 = localStorage.getItem(ACCENT_COLOR_1_STORAGE_KEY) || DEFAULT_ACCENT_COLOR_1; const c2 = localStorage.getItem(ACCENT_COLOR_2_STORAGE_KEY) || DEFAULT_ACCENT_COLOR_2; accentColorPicker1.value = c1; accentColorPicker2.value = c2; applyAccentColors(c1, c2); }
        function saveCustomApiKey() { const key = customApiKeyInput.value.trim(); if (key) { localStorage.setItem(CUSTOM_API_KEY_STORAGE_KEY, key); showSuccessMessage("API Key kustom disimpan!"); } else { localStorage.removeItem(CUSTOM_API_KEY_STORAGE_KEY); showSuccessMessage("API Key kustom dihapus."); } }
        function clearAllData() { if (confirm("Yakin hapus SEMUA data VisionTube?")) { localStorage.clear(); sessionStorage.clear(); showSuccessMessage("Semua data dihapus!"); navigateTo('home'); location.reload(); } }
        function clearCache() { cachedTrendingData = null; trendingCacheTimestamp = 0; showSuccessMessage("Cache trending dibersihkan!"); if (currentView === 'home') loadTrendingVideos(null, true); }
        function handleAccentColorChange() { const c1 = accentColorPicker1.value; const c2 = accentColorPicker2.value; applyAccentColors(c1, c2); localStorage.setItem(ACCENT_COLOR_1_STORAGE_KEY, c1); localStorage.setItem(ACCENT_COLOR_2_STORAGE_KEY, c2); }
        function resetAccentColors() { applyAccentColors(DEFAULT_ACCENT_COLOR_1, DEFAULT_ACCENT_COLOR_2); accentColorPicker1.value = DEFAULT_ACCENT_COLOR_1; accentColorPicker2.value = DEFAULT_ACCENT_COLOR_2; localStorage.removeItem(ACCENT_COLOR_1_STORAGE_KEY); localStorage.removeItem(ACCENT_COLOR_2_STORAGE_KEY); showSuccessMessage("Warna aksen direset! 🎨"); }

        // --- Desktop Sidebar Toggle ---
        function toggleDesktopSidebar() { desktopSidebarContainer.classList.toggle('open'); mainContent.classList.toggle('sidebar-open'); appHeader.classList.toggle('sidebar-open'); }

        // --- Event Listeners ---
        window.addEventListener('hashchange', () => handleHashChange(false));
        window.addEventListener('beforeunload', () => { if (currentView === 'watch' && ytPlayer && currentVideoId && typeof ytPlayer.getCurrentTime === 'function') { const state = ytPlayer.getPlayerState(); if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.PAUSED) saveLastSeenPosition(currentVideoId, ytPlayer.getCurrentTime()); } });
        document.addEventListener('DOMContentLoaded', () => { console.log("DOM Loaded. Init VisionTube v2..."); loadSettings(); handleHashChange(false); mobileMenuButton.addEventListener('click', toggleSidebar); sidebarOverlay.addEventListener('click', closeSidebar); desktopSidebarToggleButton.addEventListener('click', toggleDesktopSidebar); searchFormDesktop.addEventListener('submit', handleSearchSubmit); searchFormMobile.addEventListener('submit', handleSearchSubmit); window.addEventListener('scroll', handleScroll); trendingLoadMoreButton.addEventListener('click', () => { if (currentTrendingPageToken && !isLoadingTrending) loadTrendingVideos(currentTrendingPageToken); }); document.addEventListener('fullscreenchange', handleFullscreenChange); document.addEventListener('mozfullscreenchange', handleFullscreenChange); document.addEventListener('webkitfullscreenchange', handleFullscreenChange); document.addEventListener('msfullscreenchange', handleFullscreenChange); clearAllDataButton.addEventListener('click', clearAllData); clearCacheButton.addEventListener('click', clearCache); saveApiKeyButton.addEventListener('click', saveCustomApiKey); accentColorPicker1.addEventListener('input', handleAccentColorChange); accentColorPicker2.addEventListener('input', handleAccentColorChange); resetColorsButton.addEventListener('click', resetAccentColors); });
        function handleSearchSubmit(e) { e.preventDefault(); const input = e.target.id === 'search-form-mobile' ? searchInputMobile : searchInputDesktop; const q = input.value.trim(); if (q) { navigateTo('search', q); input.value = ''; if (e.target.id === 'search-form-mobile') closeSidebar(); } }
        function handleScroll() { if (currentView === 'search' && !isLoadingSearch && currentSearchPageToken) { const { scrollTop, scrollHeight, clientHeight } = document.documentElement; if (scrollTop + clientHeight >= scrollHeight - 600) { console.log("Scroll load more search..."); searchVideos(currentSearchQuery, currentSearchPageToken); } } }

        // --- Fullscreen Functions ---
        function handleFullscreenChange() { isFullscreen = !!(document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement); console.log("Fullscreen:", isFullscreen); youtubePlayerContainer.classList.toggle('fullscreen', isFullscreen); if (!isFullscreen) { try { if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock(); } catch (e) { console.warn("Orientation unlock error:", e); } } }

    </script>

</body>
</html>

